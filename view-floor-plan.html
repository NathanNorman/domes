<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hippie Hideout — Floor Plan (Top Down)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f0;
    color: #333;
    min-height: 100vh;
  }
  header {
    background: #2c3e50;
    color: white;
    padding: 16px 24px;
    text-align: center;
  }
  header h1 { font-size: 1.4em; font-weight: 600; letter-spacing: 0.02em; }
  header p { font-size: 0.85em; opacity: 0.7; margin-top: 4px; }

  .canvas-row {
    display: flex;
    gap: 12px;
    padding: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .canvas-wrap {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    padding: 8px;
    flex: 1 1 600px;
    max-width: 900px;
    min-width: 320px;
  }
  canvas {
    width: 100%;
    height: auto;
    display: block;
  }

  .controls {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 16px 8px;
  }
  .slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .slider-row label {
    font-weight: 600;
    font-size: 0.95em;
    white-space: nowrap;
  }
  .slider-row input[type=range] {
    flex: 1;
    accent-color: #2c3e50;
    height: 6px;
  }
  .slider-row .value {
    font-weight: 700;
    font-size: 1.1em;
    min-width: 42px;
    text-align: right;
    color: #c0392b;
  }

  .summary {
    max-width: 900px;
    margin: 8px auto;
    padding: 0 16px;
  }
  .summary-grid {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    padding: 12px 20px;
    justify-content: center;
  }
  .summary-item {
    text-align: center;
    min-width: 100px;
  }
  .summary-item .label { font-size: 0.75em; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
  .summary-item .val { font-size: 1.3em; font-weight: 700; color: #2c3e50; }

  .actions {
    text-align: center;
    padding: 12px;
  }
  .actions button {
    background: #2c3e50;
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 5px;
    font-size: 0.85em;
    cursor: pointer;
    margin: 0 4px;
    transition: background 0.2s;
  }
  .actions button:hover { background: #34495e; }

  @media (max-width: 768px) {
    .canvas-row { flex-direction: column; align-items: center; padding: 8px; gap: 8px; }
    .canvas-wrap { max-width: 100%; flex: 0 0 auto; }
    header h1 { font-size: 1.1em; }
    header { padding: 10px 16px; }
    .controls { padding: 0 8px 4px; }
    .summary { padding: 0 8px; }
    .summary-grid { padding: 8px 12px; gap: 8px; }
    .summary-item .val { font-size: 1.1em; }
    .actions { padding: 8px; }
    .actions button { padding: 6px 12px; font-size: 0.8em; }
  }
  @media print {
    header { background: white; color: black; }
    .controls, .actions { display: none; }
    .canvas-wrap { box-shadow: none; border: 1px solid #ccc; }
    body { background: white; }
  }
</style>
</head>
<body>

<header>
  <h1>Hippie Hideout — Floor Plan (Top Down)</h1>
  <p>Dome and wing footprint with dimensions driven by roof pitch</p>
</header>

<div class="canvas-row">
  <div class="canvas-wrap">
    <canvas id="floor-plan" width="1400" height="1000"></canvas>
  </div>
</div>

<div class="controls">
  <div class="slider-row">
    <label for="pitch-slider">Roof Pitch:</label>
    <input type="range" id="pitch-slider" min="20" max="35" step="0.5" value="25">
    <span class="value" id="pitch-value">25.0&deg;</span>
  </div>
</div>

<div class="summary">
  <div class="summary-grid">
    <div class="summary-item"><div class="label">Wing Room</div><div class="val" id="sum-wing">--</div></div>
    <div class="summary-item"><div class="label">Extension</div><div class="val" id="sum-ext">--</div></div>
    <div class="summary-item"><div class="label">Total Span</div><div class="val" id="sum-span">--</div></div>
    <div class="summary-item"><div class="label">Bottom Wall</div><div class="val" id="sum-bottom">--</div></div>
    <div class="summary-item"><div class="label">Pitch</div><div class="val" id="sum-pitch">--</div></div>
  </div>
</div>

<div class="actions">
  <button onclick="exportPNG()">Export PNG</button>
  <button onclick="shareLink()">Copy Share Link</button>
</div>

<script src="dome-shared.js"></script>
<script>
// ===================================================================
// Geometry Engine
// ===================================================================
function computeGeometry(pitchDeg) {
  var rad = pitchDeg * DEG2RAD;
  var horizSpan = ROOF_DROP / Math.tan(rad);
  var wallX = (LEFT_WALL_H - INTERIOR_WALL_H) / Math.tan(rad);
  var rafterLen = ROOF_DROP / Math.sin(rad);
  var rightSection = horizSpan - wallX;
  return { pitchDeg: pitchDeg, rad: rad, horizSpan: horizSpan, wallX: wallX, rafterLen: rafterLen, rightSection: rightSection };
}

// ===================================================================
// Floor Plan Renderer
// ===================================================================
function drawFloorPlan(g) {
  var canvas = document.getElementById('floor-plan');
  var setup = setupCanvas(canvas);
  var ctx = setup.ctx, w = setup.w, h = setup.h;

  var xMin = -52, xMax = 52;
  var yMin = -42, yMax = 22;
  var t = makeTransform(w, h, xMin, xMax, yMin, yMax);

  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, w, h);
  drawGrid(ctx, t, xMin, xMax, yMin, yMax, 5, 1);

  // --- Named dimensions ---
  var ENTRY_HALFWIDTH = 4.0;
  var ENTRY_DEPTH = 5.0;
  var BEDROOM_DEPTH = 17.0;
  var DOOR_WIDTH = 3.0;
  var CLOSET_DOOR_WIDTH = 2.5;

  var wallX = g.wallX, rightSection = g.rightSection;
  var r = DOME_R;
  var wallAngle = WALL_ANGLE_DEG * DEG2RAD;
  var connRad = CONN_ANGLE_DEG * DEG2RAD;

  // --- DOME setup (arc drawn after wing geometry for gap calculation) ---
  var halfWidth = ENTRY_HALFWIDTH;
  var yInt = -Math.sqrt(r * r - halfWidth * halfWidth);
  var entryAngleR = Math.atan2(yInt, halfWidth);
  var entryAngleL = Math.atan2(yInt, -halfWidth);

  drawText(ctx, t, 0, 0, 'B', { color: '#333', size: 16 });

  // --- RIGHT WING ---
  var Px = r * Math.cos(connRad);
  var Py = r * Math.sin(connRad);
  drawDot(ctx, t, Px, Py, 5);

  var weX = Px + BACK_WALL_LEN * Math.cos(wallAngle);
  var weY = Py + BACK_WALL_LEN * Math.sin(wallAngle);
  drawLine(ctx, t, Px, Py, weX, weY, '#000', 2);

  var w2Angle = wallAngle - Math.PI / 2;
  var w2DirX = Math.cos(w2Angle), w2DirY = Math.sin(w2Angle);
  var w2eX = weX + wallX * w2DirX;
  var w2eY = weY + wallX * w2DirY;
  drawLine(ctx, t, weX, weY, w2eX, w2eY, '#000', 2);
  drawDot(ctx, t, weX, weY, 4);

  var peX = w2eX + rightSection * w2DirX;
  var peY = w2eY + rightSection * w2DirY;
  drawLine(ctx, t, w2eX, w2eY, peX, peY, '#000', 2);
  drawSquare(ctx, t, peX, peY, 8);
  drawDot(ctx, t, w2eX, w2eY, 4);

  // Wall back to dome (quadratic intersection)
  var w3Angle = w2Angle - Math.PI / 2;
  var w3DirX = Math.cos(w3Angle), w3DirY = Math.sin(w3Angle);
  var aCoef = 1.0;
  var bCoef = 2 * (w2eX * w3DirX + w2eY * w3DirY);
  var cCoef = w2eX * w2eX + w2eY * w2eY - r * r;
  var disc = bCoef * bCoef - 4 * aCoef * cCoef;
  var w3eX, w3eY, tHit;
  if (disc >= 0) {
    tHit = (-bCoef - Math.sqrt(disc)) / (2 * aCoef);
    w3eX = w2eX + tHit * w3DirX;
    w3eY = w2eY + tHit * w3DirY;
    drawLine(ctx, t, w2eX, w2eY, w3eX, w3eY, '#000', 2);
    drawDot(ctx, t, w3eX, w3eY, 4);
  }

  // --- DOOR HELPER ---
  // Draws a door: white-out gap in wall, door leaf, dashed swing arc
  // hx,hy = hinge position; gapDir = unit vec along wall for gap; swingDir = unit vec into room
  function drawDoor(hx, hy, gapDirX, gapDirY, swingDirX, swingDirY, width) {
    var w = width || 3.0;
    // Erase wall segment
    drawLine(ctx, t, hx, hy, hx + w * gapDirX, hy + w * gapDirY, '#fff', 5);
    // Door leaf
    drawLine(ctx, t, hx, hy, hx + w * swingDirX, hy + w * swingDirY, '#555', 1.5);
    // Swing arc
    var closedA = Math.atan2(gapDirY, gapDirX);
    var openA = Math.atan2(swingDirY, swingDirX);
    var sweep = openA - closedA;
    if (sweep > Math.PI) sweep -= 2 * Math.PI;
    if (sweep < -Math.PI) sweep += 2 * Math.PI;
    ctx.beginPath();
    for (var i = 0; i <= 30; i++) {
      var a = closedA + (i / 30) * sweep;
      var dx = hx + w * Math.cos(a);
      var dy = hy + w * Math.sin(a);
      if (i === 0) ctx.moveTo(t.tx(dx), t.ty(dy));
      else ctx.lineTo(t.tx(dx), t.ty(dy));
    }
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 0.8;
    ctx.setLineDash([3, 3]);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // --- DOME ARC (3 segments: gaps at entry and wing attachments) ---
  function drawDomeArc(startA, endA, ghost) {
    if (endA < startA) endA += 2 * Math.PI;
    ctx.beginPath();
    var steps = Math.max(80, Math.round((endA - startA) * 80));
    for (var i = 0; i <= steps; i++) {
      var a = startA + (endA - startA) * (i / steps);
      var px = r * Math.cos(a), py = r * Math.sin(a);
      if (i === 0) ctx.moveTo(t.tx(px), t.ty(py));
      else ctx.lineTo(t.tx(px), t.ty(py));
    }
    if (ghost) {
      ctx.strokeStyle = 'rgba(200,80,80,0.25)';
      ctx.lineWidth = 0.8;
      ctx.setLineDash([3, 4]);
      ctx.stroke();
      ctx.setLineDash([]);
    } else {
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }
  if (disc >= 0) {
    var w3AngleR = Math.atan2(w3eY, w3eX);
    var w3AngleL = Math.atan2(w3eY, -w3eX);
    // Solid segments
    drawDomeArc(entryAngleR, w3AngleR);
    drawDomeArc(connRad, Math.PI - connRad);
    drawDomeArc(w3AngleL, entryAngleL);
    // Ghost arcs where dome wall was removed
    drawDomeArc(w3AngleR, connRad, true);
    drawDomeArc(Math.PI - connRad, w3AngleL, true);
  } else {
    drawDomeArc(entryAngleR, entryAngleL + 2 * Math.PI);
  }

  // Right wing dimension labels
  var perpX = Math.sin(wallAngle), perpY = -Math.cos(wallAngle);
  var wmX = (Px + weX) / 2, wmY = (Py + weY) / 2;
  drawText(ctx, t, wmX + 1.5 * perpX, wmY + 1.5 * perpY, "30'",
    { color: '#333', size: 11, rotation: WALL_ANGLE_DEG });

  var perp2X = Math.sin(w2Angle), perp2Y = -Math.cos(w2Angle);
  var w2mX = (weX + w2eX) / 2, w2mY = (weY + w2eY) / 2;
  drawText(ctx, t, w2mX + 1.5 * perp2X, w2mY + 1.5 * perp2Y, wallX.toFixed(1) + "'",
    { color: '#333', size: 11, rotation: w2Angle * 180 / Math.PI });

  var emX = (w2eX + peX) / 2, emY = (w2eY + peY) / 2;
  drawText(ctx, t, emX + 1.5 * perp2X, emY + 1.5 * perp2Y, rightSection.toFixed(1) + "'",
    { color: '#333', size: 11, rotation: w2Angle * 180 / Math.PI });

  drawText(ctx, t, weX + 1.5, weY + 1.5, "20' high", { color: '#666', size: 9 });
  drawText(ctx, t, w2eX + 1.5, w2eY + 1.5, "12' high", { color: '#666', size: 9 });
  drawText(ctx, t, peX - 1.5, peY - 1.5, "Post (8')", { color: '#333', size: 9 });

  if (disc >= 0) {
    var perp3X = Math.sin(w3Angle), perp3Y = -Math.cos(w3Angle);
    var w3mX = (w2eX + w3eX) / 2, w3mY = (w2eY + w3eY) / 2;
    drawText(ctx, t, w3mX + 2 * perp3X, w3mY + 2 * perp3Y, tHit.toFixed(1) + "'",
      { color: '#333', size: 11, rotation: w3Angle * 180 / Math.PI + 180 });
  }

  // --- RIGHT WING BEDROOM ---
  var bedroomDepth = BEDROOM_DEPTH;
  var b1x = weX + bedroomDepth * (Px - weX) / BACK_WALL_LEN;
  var b1y = weY + bedroomDepth * (Py - weY) / BACK_WALL_LEN;
  var b2x = w2eX + bedroomDepth * w3DirX;
  var b2y = w2eY + bedroomDepth * w3DirY;
  drawLine(ctx, t, b1x, b1y, b2x, b2y, '#000', 2);
  drawDot(ctx, t, b1x, b1y, 4);
  drawDot(ctx, t, b2x, b2y, 4);

  // Bedroom label
  var brCx = (weX + b1x + b2x + w2eX) / 4;
  var brCy = (weY + b1y + b2y + w2eY) / 4;
  drawText(ctx, t, brCx, brCy, 'Bedroom', { color: '#555', size: 11 });
  drawText(ctx, t, brCx, brCy - 1.5, '17\' × ' + wallX.toFixed(1) + '\'', { color: '#888', size: 9 });

  // --- RIGHT WING BATHROOM (16' deep, length computed to touch dome) ---
  var bathWallDepth = BEDROOM_DEPTH; // perpendicular to back wall (matches bedroom depth)
  var backToPx = (Px - weX) / BACK_WALL_LEN;
  var backToPy = (Py - weY) / BACK_WALL_LEN;
  // bath4 = B1 + 16' perpendicular to back wall (on bedroom partition line)
  var bath4x = b1x + bathWallDepth * w2DirX;
  var bath4y = b1y + bathWallDepth * w2DirY;
  // Compute bathLen so bath3 = bath4 + bathLen*backToP lands on dome circle
  var bqa = 1.0;
  var bqb = 2 * (bath4x * backToPx + bath4y * backToPy);
  var bqc = bath4x * bath4x + bath4y * bath4y - r * r;
  var bqdisc = bqb * bqb - 4 * bqa * bqc;
  if (bqdisc >= 0) {
    var bathLen = (-bqb - Math.sqrt(bqdisc)) / (2 * bqa);
    var bath2x = b1x + bathLen * backToPx;
    var bath2y = b1y + bathLen * backToPy;
    var bath3x = bath4x + bathLen * backToPx;
    var bath3y = bath4y + bathLen * backToPy;
    // Two new walls (back wall B1→bath2 and partition B1→bath4 already drawn)
    drawLine(ctx, t, bath2x, bath2y, bath3x, bath3y, '#000', 2);
    drawLine(ctx, t, bath3x, bath3y, bath4x, bath4y, '#000', 2);
    drawDot(ctx, t, bath2x, bath2y, 4);
    drawDot(ctx, t, bath3x, bath3y, 4);
    drawDot(ctx, t, bath4x, bath4y, 4);
    // Label
    var bathCx = (b1x + bath2x + bath3x + bath4x) / 4;
    var bathCy = (b1y + bath2y + bath3y + bath4y) / 4;
    drawText(ctx, t, bathCx, bathCy, 'Bath', { color: '#555', size: 11 });
    drawText(ctx, t, bathCx, bathCy - 1.5, Math.round(bathLen) + '\' × 17\'', { color: '#888', size: 9 });
  }

  // --- LEFT WING (mirror) ---
  var mPLx = -Px, mPLy = Py;
  drawDot(ctx, t, mPLx, mPLy, 5);

  var mweLx = -weX, mweLy = weY;
  drawLine(ctx, t, mPLx, mPLy, mweLx, mweLy, '#000', 2);

  var mw2eLx = -w2eX, mw2eLy = w2eY;
  drawLine(ctx, t, mweLx, mweLy, mw2eLx, mw2eLy, '#000', 2);
  drawDot(ctx, t, mweLx, mweLy, 4);

  var mpeLx = -peX, mpeLy = peY;
  drawLine(ctx, t, mw2eLx, mw2eLy, mpeLx, mpeLy, '#000', 2);
  drawSquare(ctx, t, mpeLx, mpeLy, 8);
  drawDot(ctx, t, mw2eLx, mw2eLy, 4);

  if (disc >= 0) {
    var mw3eLx = -w3eX, mw3eLy = w3eY;
    drawLine(ctx, t, mw2eLx, mw2eLy, mw3eLx, mw3eLy, '#000', 2);
    drawDot(ctx, t, mw3eLx, mw3eLy, 4);

    var mw3mLx = -(w2eX + w3eX) / 2, mw3mLy = (w2eY + w3eY) / 2;
    drawText(ctx, t, mw3mLx - 2 * perp3X, mw3mLy + 2 * perp3Y, tHit.toFixed(1) + "'",
      { color: '#333', size: 11, rotation: -(w3Angle * 180 / Math.PI + 180) });
  }

  // --- LEFT WING BEDROOM (mirror) ---
  var mb1x = -b1x, mb1y = b1y;
  var mb2x = -b2x, mb2y = b2y;
  drawLine(ctx, t, mb1x, mb1y, mb2x, mb2y, '#000', 2);
  drawDot(ctx, t, mb1x, mb1y, 4);
  drawDot(ctx, t, mb2x, mb2y, 4);
  drawText(ctx, t, -brCx, brCy, 'Workshop', { color: '#555', size: 11 });
  drawText(ctx, t, -brCx, brCy - 1.5, '17\' × ' + wallX.toFixed(1) + '\'', { color: '#888', size: 9 });

  // --- LEFT WING SMALL BATHROOM (square between B2 and W3) ---
  if (disc >= 0) {
    var smallBathSide = tHit - bedroomDepth; // distance along inner wall from B2 to W3
    // Right wing corners (then mirror x for left wing)
    var sb3x = w3eX - smallBathSide * w2DirX;
    var sb3y = w3eY - smallBathSide * w2DirY;
    var sb4x = b2x - smallBathSide * w2DirX;
    var sb4y = b2y - smallBathSide * w2DirY;
    // Left wing (negate x)
    var msb3x = -sb3x, msb3y = sb3y;
    var msb4x = -sb4x, msb4y = sb4y;
    // Wall from left W3 perpendicular to inner wall
    drawLine(ctx, t, -w3eX, w3eY, msb3x, msb3y, '#000', 2);
    // Wall parallel to inner wall (connects the two perpendicular walls)
    drawLine(ctx, t, msb3x, msb3y, msb4x, msb4y, '#000', 2);
    // Wall from left B2 perpendicular (shares line with bedroom partition, draw for closure)
    drawLine(ctx, t, msb4x, msb4y, mb2x, mb2y, '#000', 2);
    drawDot(ctx, t, msb3x, msb3y, 4);
    drawDot(ctx, t, msb4x, msb4y, 4);
    // Label
    var sbCx = (-w3eX + msb3x + msb4x + mb2x) / 4;
    var sbCy = (w3eY + msb3y + msb4y + mb2y) / 4;
    drawText(ctx, t, sbCx, sbCy, 'Bath', { color: '#555', size: 11 });
    drawText(ctx, t, sbCx, sbCy - 1.5, Math.round(smallBathSide) + '\' × ' + Math.round(smallBathSide) + '\'', { color: '#888', size: 9 });
  }

  // Left wing dimension labels
  var mwmLx = -wmX, mwmLy = wmY;
  drawText(ctx, t, mwmLx - 1.5 * perpX, mwmLy + 1.5 * perpY, "30'",
    { color: '#333', size: 11, rotation: -WALL_ANGLE_DEG });

  var mw2mLx = -w2mX, mw2mLy = w2mY;
  drawText(ctx, t, mw2mLx - 1.5 * perp2X, mw2mLy + 1.5 * perp2Y, wallX.toFixed(1) + "'",
    { color: '#333', size: 11, rotation: -(w2Angle * 180 / Math.PI) });

  var memLx = -emX, memLy = emY;
  drawText(ctx, t, memLx - 1.5 * perp2X, memLy + 1.5 * perp2Y, rightSection.toFixed(1) + "'",
    { color: '#333', size: 11, rotation: -(w2Angle * 180 / Math.PI) });

  drawText(ctx, t, mweLx - 1.5, mweLy + 1.5, "20' high", { color: '#666', size: 9, align: 'right' });
  drawText(ctx, t, mw2eLx - 1.5, mw2eLy + 1.5, "12' high", { color: '#666', size: 9, align: 'right' });
  drawText(ctx, t, mpeLx + 1.5, mpeLy - 1.5, "Post (8')", { color: '#333', size: 9 });

  // --- FRONT ENTRY BOX ---
  // halfWidth and yInt already defined above (dome section)
  drawDot(ctx, t, -halfWidth, yInt, 5);
  drawDot(ctx, t, halfWidth, yInt, 5);

  // Dome face wall with door opening centered, hinged right, swings inward
  drawLine(ctx, t, -halfWidth, yInt, halfWidth, yInt, '#000', 2);
  drawDoor(DOOR_WIDTH / 2, yInt, -1, 0, 0, 1, DOOR_WIDTH);

  // Entry box side walls and solid bottom wall
  var leftBot = [-halfWidth, yInt - ENTRY_DEPTH];
  var rightBot = [halfWidth, yInt - ENTRY_DEPTH];
  drawLine(ctx, t, -halfWidth, yInt, leftBot[0], leftBot[1], '#000', 2);
  drawLine(ctx, t, halfWidth, yInt, rightBot[0], rightBot[1], '#000', 2);
  drawLine(ctx, t, leftBot[0], leftBot[1], rightBot[0], rightBot[1], '#000', 2);

  // Front arc between posts
  var botY = leftBot[1];
  var arcCy = (peX * peX + peY * peY - botY * botY) / (2 * (peY - botY));
  var arcRad = Math.abs(arcCy - botY);
  var aRight = Math.atan2(peY - arcCy, peX);
  var aLeft = Math.atan2(mpeLy - arcCy, mpeLx);

  ctx.beginPath();
  for (var ai = 0; ai <= 200; ai++) {
    var aa = aRight + (aLeft - aRight) * (ai / 200);
    var ax = arcRad * Math.cos(aa);
    var ay = arcCy + arcRad * Math.sin(aa);
    if (ai === 0) ctx.moveTo(t.tx(ax), t.ty(ay));
    else ctx.lineTo(t.tx(ax), t.ty(ay));
  }
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.5;
  ctx.stroke();
  ctx.globalAlpha = 1.0;

  // --- ENTRYWAY CLOSETS ---
  // Extend closets to W3 (inner wall → dome attachment point)
  var closetY = (disc >= 0) ? w3eY : yInt + 4.0;
  var closetDomeX = Math.sqrt(r * r - closetY * closetY);

  // Right closet: vertical wall then horizontal to dome
  drawLine(ctx, t, halfWidth, yInt, halfWidth, closetY, '#000', 2);
  drawLine(ctx, t, halfWidth, closetY, closetDomeX, closetY, '#000', 2);
  drawDot(ctx, t, closetDomeX, closetY, 4);

  // Left closet: mirror
  drawLine(ctx, t, -halfWidth, yInt, -halfWidth, closetY, '#000', 2);
  drawLine(ctx, t, -halfWidth, closetY, -closetDomeX, closetY, '#000', 2);
  drawDot(ctx, t, -closetDomeX, closetY, 4);

  // Closet labels (offset toward dome side to avoid wall overlap)
  var closetLabelX = (halfWidth + closetDomeX) * 0.55;
  var closetLabelY = (yInt + closetY) / 2;
  drawText(ctx, t, closetLabelX, closetLabelY, 'Storage', { color: '#666', size: 9 });
  drawText(ctx, t, -closetLabelX, closetLabelY, 'Storage', { color: '#666', size: 9 });

  // --- INTERIOR DOORS ---
  if (disc >= 0) {
    // Right wing bedroom door — in partition B1→B2, 8' from B1 (en-suite to bathroom)
    var rbd_hx = b1x + 8 * w2DirX, rbd_hy = b1y + 8 * w2DirY;
    drawDoor(rbd_hx, rbd_hy, w2DirX, w2DirY, -w3DirX, -w3DirY);

    // Right wing bathroom door — in bath2→bath3 wall, 3/4 up from bath2
    if (typeof bath2x !== 'undefined') {
      var rbtd_hx = bath2x + 12.75 * w2DirX, rbtd_hy = bath2y + 12.75 * w2DirY;
      drawDoor(rbtd_hx, rbtd_hy, w2DirX, w2DirY, -w3DirX, -w3DirY);
    }

    // Left wing workshop door — in partition, 3' from mb1 (back wall end)
    // Mirror: left w2Dir = (-w2DirX, w2DirY), left -w3Dir = (w3DirX, -w3DirY)
    var lwd_hx = -b1x - 3 * w2DirX, lwd_hy = b1y + 3 * w2DirY;
    drawDoor(lwd_hx, lwd_hy, -w2DirX, w2DirY, w3DirX, -w3DirY);

    // Left wing bathroom door — in msb4→mb2 wall, 3' from mb2 toward msb4
    // Mirror: gap toward mb2 = left w2Dir, swing into bath = left w3Dir
    var lbd_hx = -b2x + 3 * w2DirX, lbd_hy = b2y - 3 * w2DirY;
    drawDoor(lbd_hx, lbd_hy, -w2DirX, w2DirY, -w3DirX, w3DirY, CLOSET_DOOR_WIDTH);
  }

  // Storage closet doors — open toward dome interior
  // Right closet
  drawDoor(halfWidth + 1.5, closetY, 1, 0, 0, 1, CLOSET_DOOR_WIDTH);
  // Left closet
  drawDoor(-(halfWidth + 1.5), closetY, -1, 0, 0, 1, CLOSET_DOOR_WIDTH);

  // Title
  ctx.font = 'bold 14px -apple-system, sans-serif';
  ctx.fillStyle = '#333';
  ctx.textAlign = 'center';
  ctx.fillText('Floor Plan (Top Down)', w / 2, 20);

  // Axis labels
  ctx.font = '10px -apple-system, sans-serif';
  ctx.fillStyle = '#888';
  ctx.textAlign = 'center';
  ctx.fillText('Feet', w / 2, h - 4);
  ctx.save();
  ctx.translate(12, h / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('Feet', 0, 0);
  ctx.restore();

  return tHit;
}

// ===================================================================
// Update Loop
// ===================================================================
function update() {
  var pitchDeg = parseFloat(slider.value);
  var g = computeGeometry(pitchDeg);
  document.getElementById('pitch-value').textContent = pitchDeg.toFixed(1) + '\u00B0';

  var tHit = drawFloorPlan(g);

  document.getElementById('sum-wing').textContent = g.wallX.toFixed(1) + "'";
  document.getElementById('sum-ext').textContent = g.rightSection.toFixed(1) + "'";
  document.getElementById('sum-span').textContent = g.horizSpan.toFixed(1) + "'";
  document.getElementById('sum-bottom').textContent = tHit ? tHit.toFixed(1) + "'" : '--';
  document.getElementById('sum-pitch').textContent = pitchDeg.toFixed(1) + '\u00B0';

  history.replaceState(null, '', '#pitch=' + pitchDeg.toFixed(1));
}

// ===================================================================
// Export / Share
// ===================================================================
function exportPNG() {
  var canvas = document.getElementById('floor-plan');
  canvas.toBlob(function(blob) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'floor-plan-' + slider.value + 'deg.png';
    a.click();
    URL.revokeObjectURL(url);
  });
}

function shareLink() {
  var url = window.location.href;
  navigator.clipboard.writeText(url).then(function() {
    var btns = document.querySelectorAll('.actions button');
    var btn = btns[1];
    var orig = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.textContent = orig; }, 1500);
  });
}

// ===================================================================
// Init
// ===================================================================
var slider = document.getElementById('pitch-slider');

var hashMatch = window.location.hash.match(/pitch=([\d.]+)/);
if (hashMatch) {
  var v = parseFloat(hashMatch[1]);
  if (v >= 20 && v <= 35) slider.value = v;
}

slider.addEventListener('input', update);
window.addEventListener('resize', update);

window.addEventListener('message', function(e) {
  if (e.data && e.data.type === 'setPitch') {
    var v = parseFloat(e.data.value);
    if (v >= 20 && v <= 35) { slider.value = v; update(); }
  }
});

update();
</script>
</body>
</html>
